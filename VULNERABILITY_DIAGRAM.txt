================================================================================
SECURITY AUDIT VISUAL DIAGRAMS
Mora MCQ Placeholder Vulnerability Analysis
================================================================================

DIAGRAM 1: VULNERABILITY LOCATION
================================================================================

question_service.py — generate_next() function:

    Line 232-242: Generate question via LLM
    ┌──────────────────────────────────────────────────────┐
    │  q_data, model, prompt = question_generator.generate( │
    │      focus_node['name'],                              │
    │      node_desc,                                       │
    │      ...                                              │
    │  )                                                     │
    │  # q_data = { 'question': '...', 'correct_answer': ...} │
    │  # UNTRUSTED: comes from LLM                           │
    └──────────────────────────────────────────────────────┘
                            ↓
    Line 262-270: CREATE PLACEHOLDERS ⚠️ VULNERABILITY HERE
    ┌──────────────────────────────────────────────────────┐
    │  if q_type == 'mcq' and q_data and not             │
    │     q_data.get('options'):                          │
    │      correct = q_data.get('correct_answer', '')     │
    │      # No sanitization! ↓                           │
    │      q_data['options'] = [                          │
    │          f'A) {correct}',  # ← INJECTION HERE       │
    │          f'B) alt{attempt_num}a',                   │
    │          f'C) alt{attempt_num}b',                   │
    │          f'D) alt{attempt_num}c'                    │
    │      ]                                              │
    └──────────────────────────────────────────────────────┘
                            ↓
    Line 272-276: VALIDATE (incomplete)
    ┌──────────────────────────────────────────────────────┐
    │  is_valid, reason = validate_question(q_data, ...)  │
    │  # Checks: '</' in answer, '```' in answer          │
    │  # Does NOT check options array!                    │
    │  # Does NOT check for: onclick=, newlines, etc      │
    └──────────────────────────────────────────────────────┘
                            ↓
    Line 294-295: COMPUTE DISTRACTORS
    ┌──────────────────────────────────────────────────────┐
    │  if q_type == 'mcq' and q_data:                     │
    │      q_data = insert_distractors(q_data)            │
    │  # Replaces placeholders with real distractors      │
    │  # BUT: if this fails, placeholder reaches student! │
    └──────────────────────────────────────────────────────┘
                            ↓
    Line 307-311: STORE IN DATABASE
    ┌──────────────────────────────────────────────────────┐
    │  question_id = question_model.create(                │
    │      ...                                             │
    │      options=json.dumps(q_data.get('options')),     │
    │      correct_answer=q_data.get('correct_answer'),   │
    │      ...                                             │
    │  )                                                    │
    │  # JSON escaping: " → \"  (partial mitigation)      │
    └──────────────────────────────────────────────────────┘
                            ↓
    FRONTEND RENDERING (templates/session/question.html)
    ┌──────────────────────────────────────────────────────┐
    │  {% for option in question.options %}               │
    │      <button value="{{ option }}"...>               │
    │          <span>{{ option | render_math }}</span>    │
    │      </button>                                       │
    │  {% endfor %}                                        │
    │                                                      │
    │  Jinja2 escaping: " → &quot;  (but render_math      │
    │  uses Markup() which bypasses this)                 │
    └──────────────────────────────────────────────────────┘
                            ↓
    STUDENT BROWSER: POTENTIAL XSS EXECUTION
    ┌──────────────────────────────────────────────────────┐
    │  If escaping fails:                                  │
    │  <button value="A) 5" onclick="alert(1)">           │
    │      <span>5" onclick="alert(1)</span>              │
    │  </button>                                          │
    │                                                      │
    │  JavaScript could execute when user interacts       │
    └──────────────────────────────────────────────────────┘


================================================================================
DIAGRAM 2: ATTACK SURFACE MAP
================================================================================

INPUT VALIDATION FLOW:

    LLM Output (JSON)
           │
           ├─→ Parse JSON ✓ (safe parsing)
           │
           ├─→ Check keys exist ✓
           │
           ├─→ check question length ✓ (Rule 1)
           │
           ├─→ check answer not empty ✓ (Rule 2)
           │
           ├─→ check choices unique ✓ (Rule 3)
           │
           ├─→ check answer in choices ✓ (Rule 4)
           │
           ├─→ check answer not in question ✓ (Rule 5)
           │
           ├─→ check no placeholder text ✓ (Rule 6)
           │
           ├─→ check answer length < 200 ✓ (Rule 7)
           │
           ├─→ check no HTML artifacts ✓ (Rule 8)
           │     (but: only checks '</' and '```')
           │     (misses: onclick=, newlines, etc)
           │
           ├─→ [MORE VALIDATION RULES 9-17...]
           │
           ├─→ CREATE PLACEHOLDERS ✗ (NO VALIDATION!)
           │     correct = q_data['correct_answer']  ← UNTRUSTED
           │     options = [f'A) {correct}', ...]   ← UNVALIDATED
           │
           └─→ INSERT_DISTRACTORS ⚠️ (uses original unvalidated correct)
                     │
                     ├─→ if success: options replaced ✓
                     └─→ if skip/fail: options still unvalidated ✗


ATTACK SURFACE SUMMARY:
════════════════════════════════════════════════════════════════

Entry Point:    LLM-generated correct_answer
├─ No sanitization before f-string interpolation
├─ Validation checks incomplete (string-only, not comprehensive)
├─ Stored in DB as-is (JSON escaping insufficient)
├─ Rendered to student via Jinja2 (escaping may fail)
└─ Can execute JavaScript if bypasses all mitigations


================================================================================
DIAGRAM 3: PAYLOAD FLOW ANALYSIS
================================================================================

EXAMPLE: XSS PAYLOAD "5\" onclick=\"alert(1)"

    CREATION:
    ─────────────────────────────────────────────────────────
    LLM outputs: correct_answer = '5" onclick="alert(1)'
                                      │
                                      ├─ Contains: double quote (")
                                      ├─ Contains: onclick= (event handler)
                                      └─ Designed to break HTML attribute

    INTERPOLATION:
    ─────────────────────────────────────────────────────────
    f'A) {correct}' = f'A) 5" onclick="alert(1)'
                    = 'A) 5" onclick="alert(1)'
                      │
                      ├─ The quote is now INSIDE the f-string
                      ├─ It can escape the HTML attribute context
                      └─ The onclick= pattern is now in the option

    VALIDATION:
    ─────────────────────────────────────────────────────────
    Check: '</' in answer?  NO ✗ (not matched)
    Check: '```' in answer? NO ✗ (not matched)
    Check: OTHER PATTERNS?
           └─ onclick= not checked
           └─ newlines not checked
           └─ null bytes not checked
           └─ other protocols not checked
    Result: VALIDATION PASSES ✓ (INCORRECT!)

    STORAGE:
    ─────────────────────────────────────────────────────────
    json.dumps(['A) 5" onclick="alert(1)', ...])
    = '["A) 5\\" onclick=\\"alert(1)", ...]'
       │
       └─ JSON escaping: " becomes \"  (temporary safety)

    When retrieved from DB:
    json.loads(...)
    = ['A) 5" onclick="alert(1)', ...]
       │
       └─ Back to dangerous form!

    RENDERING:
    ─────────────────────────────────────────────────────────
    Template: <button value="{{ option }}"...>
    Jinja2 escaping: " → &quot;
    Result: <button value="A) 5&quot; onclick=&quot;alert(1)"...>
                           ↑                    ↑
                           HTML escaped         HTML escaped
    This renders safely!

    BUT: if render_math filter is involved:
    Template: <span>{{ option | render_math }}</span>
    render_math: May use Markup() which bypasses escaping
    Result: Could be <span>A) 5" onclick="alert(1)</span>
    If javascript: protocol is converted: VULNERABLE!

    EXECUTION:
    ─────────────────────────────────────────────────────────
    If HTML escaping fails:
    <button value="A) 5" onclick="alert(1)">
    Browser sees: 'A) 5"' as the value
                  onclick="alert(1)" as an event handler
    When clicked: JavaScript executes!


================================================================================
DIAGRAM 4: DEFENSE LAYERS (CURRENT vs RECOMMENDED)
================================================================================

CURRENT STATE:
═════════════════════════════════════════════════════════════════

    ATTACK ──→ INPUT ──→ f-string ──→ VALIDATION ──→ DB ──→ FRONTEND ──→ XSS?
                (untrusted) (no sanitization) (incomplete) (JSON)  (Jinja2)
                                                                         │
    Layer 1: f-string sanitization        ✗ MISSING
    Layer 2: f-string output              ─ (no escaping)
    Layer 3: Validation                   ⚠️ INCOMPLETE (string checks only)
    Layer 4: Database storage             ⚠️ PARTIAL (JSON escaping ≠ HTML)
    Layer 5: Frontend rendering           ⚠️ FRAGILE (depends on filter order)
    Layer 6: CSP header                   ✗ MISSING
                                                                         └→ RISK

RECOMMENDED STATE:
═════════════════════════════════════════════════════════════════

    ATTACK ──→ INPUT ──→ SANITIZE ──→ f-string ──→ VALIDATION ──→ DB ──→ FRONTEND ──→ XSS?
                (untrusted)   (new)         ✓       (comprehensive)  (JSON)   (Jinja2)
                                                                                    │
    Layer 1: Input sanitization           ✓ ADDED (remove control chars)
    Layer 2: f-string output              ✓ (sanitized input)
    Layer 3: Validation                   ✓ ENHANCED (check options array)
    Layer 4: Database storage             ✓ (JSON + sanitized input)
    Layer 5: Frontend rendering           ✓ (Jinja2 + sanitized input)
    Layer 6: CSP header                   ✓ ADDED (blocks inline scripts)
    Layer 7: render_math review           ✓ VERIFIED (escaping order)
                                                                                    └→ SAFE


================================================================================
DIAGRAM 5: REMEDIATION DEPENDENCY GRAPH
================================================================================

                    ┌─────────────────────────┐
                    │ Add sanitization utils  │ (Fix 1: 15 min)
                    └────────┬────────────────┘
                             │
                    ┌────────┴────────────────┐
                    │                         │
      ┌─────────────▼──────────┐    ┌────────▼────────────────┐
      │ Update placeholder gen │    │ Update distractors      │
      │ to use sanitization    │    │ to use sanitization     │
      │ (Fix 2: 5 min)         │    │ (Fix 4: 30 min)         │
      └─────────────┬──────────┘    └────────┬────────────────┘
                    │                         │
                    └────────┬────────────────┘
                             │
                    ┌────────▼────────────────┐
                    │ Add validation rules    │ (Fix 3: 2 hours)
                    │ to question_validator   │
                    └────────┬────────────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
   ┌──────────▼─────┐  ┌─────▼────────┐  ┌─▼───────────┐
   │ Add CSP header │  │ Review       │  │ Add security│
   │ (Fix 5: 20m)   │  │ render_math  │  │ tests       │
   │                │  │ (Fix 6: 2h)  │  │ (Fix 7: 3h) │
   └────────────────┘  └──────────────┘  └─────────────┘

CRITICAL PATH (minimum to deploy):
    Fix 1 ──→ Fix 2 ──→ Fix 3 ──→ Deploy
    (15m)     (5m)      (2h)

Total critical path: ~2.5 hours
All fixes: ~5 hours


================================================================================
DIAGRAM 6: RISK HEAT MAP
================================================================================

                     PROBABILITY
                 LOW  MED  HIGH
             ┌────┬────┬────┐
        HIGH │ 4  │ 5  │ 9  │  ▲ XSS in educational app
             ├────┼────┼────┤  │ Data breach
        MED  │ 2  │ 3  │ 7  │  │ Student experience impact
             ├────┼────┼────┤
        LOW  │ 1  │ 6  │ 8  │
             └────┴────┴────┘
                 IMPACT

YOUR VULNERABILITY: Cell 3 (Medium impact × Medium probability)
  • Current mitigation: Reduces to Cell 6 (Low impact but still Medium prob)
  • With full remediation: Reduces to Cell 1 (Low impact × Low probability)

Color coding:
  1-2: Green (acceptable risk)
  3-4: Yellow (should mitigate)
  5-9: Red (must mitigate)


================================================================================
DIAGRAM 7: TIMELINE AND MILESTONES
================================================================================

WEEK 1 (CRITICAL):
───────────────────────────────────────────────────────────
Day 1 (Wed):
  ├─ 15 min: Add sanitization function
  ├─ 5 min:  Update placeholder creation
  ├─ 1 hour: Test and verify
  └─ End of day: Deploy Fix 1 & 2

Day 2 (Thu):
  ├─ 2 hours: Add validation rules
  ├─ 30 min:  Update distractors
  ├─ 1 hour:  Test and verify
  └─ End of day: Deploy Fix 3 & 4

Day 3 (Fri):
  ├─ 20 min: Add CSP header
  ├─ 30 min: Test headers
  ├─ 30 min: Final verification
  └─ End of day: Deploy Fix 5

Status at end of Week 1: 80% of fixes deployed, critical issues resolved

WEEK 2 (ENHANCEMENT):
───────────────────────────────────────────────────────────
Day 1 (Mon):
  ├─ 2 hours: Review render_math_in_text()
  └─ 1 hour:  Implement any needed fixes

Day 2 (Tue):
  ├─ 2 hours: Create security utils module
  ├─ 3 hours: Add comprehensive tests
  └─ 1 hour:  Update documentation

Status at end of Week 2: All fixes deployed, tests passing, docs updated


================================================================================
DIAGRAM 8: COST-BENEFIT ANALYSIS
================================================================================

OPTION A: REMEDIATE IMMEDIATELY
─────────────────────────────────────────────────────────
Cost:       5-6 hours developer time
Benefit:    Eliminates medium-risk XSS vulnerability
Timeline:   2 weeks to full implementation
Risk:       Low (backward compatible changes)
Payoff:     High (prevents potential breaches)
Effort:     ~300 LOC changed/added

Return on Investment:
  Risk reduction: MEDIUM → LOW
  Coverage: Input → Validation → Storage → Rendering
  Technical debt: -1 (reduces debt by adding proper validation)


OPTION B: ACCEPT RISK (DO NOT REMEDIATE)
─────────────────────────────────────────────────────────
Cost:       0 (no development time)
Benefit:    Fast feature delivery
Timeline:   N/A
Risk:       MEDIUM (XSS still possible)
Payoff:     Potential breach at unpredictable time
Effort:     0

Return on Investment:
  Risk reduction: NONE
  Coverage: Relies on framework-level mitigations
  Technical debt: +1 (accumulates security debt)

Recommendation: OPTION A (Remediate)
────────────────────────────────────
5 hours of development << Cost of security breach
Medium risk << Acceptable for production application


================================================================================

Generated by: Security Audit Analysis
Date: 2026-02-12
Reference: SECURITY_AUDIT_MCQ_PLACEHOLDERS.md

EOF
